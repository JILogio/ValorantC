version: 2.1

orbs:
  node: circleci/node@5.2
  slack: circleci/slack@4.8.0  # Orb de Slack para notificaciones

executors:
  node-executor:
    docker:
      - image: node:18.17

jobs:
  # Job: Clonar el repositorio
  clone_repo:
    executor: node-executor
    steps:
      - checkout  # Clona el repositorio
      - run:
          name: Verify Repo Clone
          command: ls -al  # Verificar que se ha clonado correctamente

  # Job: Correr los tests
  run_tests:
    executor: node-executor
    parallelism: 2
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: esports-valorant-backend/
      - run:
          name: Run Tests
          command: npm run test  # Comando para correr las pruebas
          working_directory: esports-valorant-backend/

  # Job: Lint Code
  lint_code:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: esports-valorant-backend/
      - run:
          name: Lint Code
          command: npm run lint  # Comando para revisar el estilo de c칩digo
          working_directory: esports-valorant-backend/

  # Job: An치lisis de seguridad con npm audit
  security_audit:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Security Audit
          command: npm audit  # An치lisis de vulnerabilidades en las dependencias

workflows:
    # Primer workflow: Clonar el repo y correr los tests
  clone_and_test:
    jobs:
      - clone_repo
      - run_tests:
          requires:
            - clone_repo

  # Segundo workflow: Lint y An치lisis de Seguridad
  lint_and_security_audit:
    jobs:
      - lint_code
      - security_audit:
          requires:
            - lint_code

# Notificaciones de Slack
notify_on_success:
  jobs:
    - slack/notify:
        channel: "#devops"
        event: success
notify_on_failure:
  jobs:
    - slack/notify:
        channel: "#devops"
        event: fail